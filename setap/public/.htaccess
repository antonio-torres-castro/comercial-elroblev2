# .htaccess - Carpeta /setap/public/
# Front controller (URLs limpias) — permite que index.php maneje rutas
# Codificacion UTF-8

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /setap/public/
    
    # ===== OPTIMIZACION PARA DEBUG =====
    # Permitir acceso a archivos estaticos
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$
    RewriteRule ^ - [L]
    
    # Redirigir a HTTPS si esta detras de un proxy con HTTPS
    RewriteCond %{HTTP:X-Forwarded-Proto} =https
    RewriteRule ^ - [E=HTTPS:on]

    # Si archivo o carpeta existe, servirlo directamente
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Redirigir todo lo demás a index.php
    RewriteRule ^ index.php [L,QSA]
</IfModule>

# ===== CONFIGURACION GENERAL =====
Options -Indexes

# Priorizar index.php
DirectoryIndex index.php index.html

# ===== HEADERS DE SEGURIDAD =====
<IfModule mod_headers.c>
    # Headers de seguridad basicos
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remover headers que revelan informacion del servidor
    Header unset X-Powered-By
    Header unset Server
    
    # Headers especificos para modo debug
    <Files "index.php">
        Header set X-App-Debug "enabled"
    </Files>
</IfModule>

# ===== PROTECCION DE ARCHIVOS SENSIBLES =====
<FilesMatch "\.(env|ini|phps|log|sh|bak|config|sql)$">
    <RequireAll>
        Require all denied
    </RequireAll>
</FilesMatch>

# ===== PROTECCION CONTRA ATAQUES =====
<IfModule mod_rewrite.c>
    # Prevenir ataques de inclusion de archivos
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=https:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=(\.\./?)* [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=/([a-z0-9_.]/?)+ [NC]
    RewriteRule .* - [F]
    
    # Bloquear intentos de SQL injection
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (SELECT|INSERT|UPDATE|DELETE|DROP|CREATE) [NC,OR]
    RewriteCond %{QUERY_STRING} (UNION|SELECT|INSERT|UPDATE|DELETE|DROP|CREATE) [NC,OR]
    RewriteCond %{QUERY_STRING} concat [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Bloquear archivos maliciosos comunes
    RewriteRule ^(.*)/phpinfo\.php$ - [F,L]
    RewriteRule ^(.*)/eval\(.*$ - [F,L]
    RewriteRule ^(.*)/base64_decode\(.*$ - [F,L]
</IfModule>

# ===== CONFIGURACION PARA MANEJO DE ERRORES =====
<Files "detailed_errors.php">
    <RequireAll>
        Require all granted
    </RequireAll>
</Files>

<Files "error_analyzer.php">
    <RequireAll>
        Require all granted
    </RequireAll>
</Files>

# ===== CACHE OPTIMIZADO =====
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType application/font-woff "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
    ExpiresDefault "access plus 1 month"
</IfModule>

# ===== COMPRESION =====
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
</IfModule>

# ===== CONFIGURACION PHP PARA DEBUG =====
<IfModule mod_php.c>
    php_flag display_errors On
    php_flag display_startup_errors On
    php_value error_reporting E_ALL
    php_value log_errors On
    php_value error_log "/setap/logs/php_errors.log"
</IfModule>

# ===== PHP HANDLER =====
<IfModule mime_module>
  ## PHP Handler (production - cPanel EasyApache)
  #AddHandler application/x-httpd-ea-php83 .php .php8 .phtml
</IfModule>

# ===== HEADERS FINALES =====
<IfModule mod_headers.c>
    Header set X-Debug-Public "enabled"
    Header set X-Error-Handling "verbose"
    Header set X-Cache-Policy "debug-friendly"
</IfModule>

# ===== CHARSET =====
AddDefaultCharset UTF-8
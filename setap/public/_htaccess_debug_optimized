# .htaccess DEBUG OPTIMIZADO - Carpeta /setap/public/
# Renombra a .htaccess cuando subas al servidor

# Front controller (URLs limpias) — permite que index.php maneje rutas
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /setap/public/
    
    # ===== OPTIMIZACIÓN PARA DEBUG =====
    # Permitir acceso a archivos de debug desde public
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_FILENAME} \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$
    RewriteRule ^ - [L]
    
    # Redirigir a HTTPS si está detrás de un proxy con HTTPS
    RewriteCond %{HTTP:X-Forwarded-Proto} =https
    RewriteRule ^ - [E=HTTPS:on]
    
    # Si archivo o carpeta existe, servirlo directamente
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    
    # Redirigir todo lo demás a index.php
    RewriteRule ^ index.php [L,QSA]
</IfModule>

# ===== CONFIGURACIÓN ESPECIAL PARA DEBUG =====
# Evitar listado de directorios
Options -Indexes

# Priorizar index.php
DirectoryIndex index.php index.html

# ===== HEADERS DE SEGURIDAD MEJORADOS =====
<IfModule mod_headers.c>
    # Headers de seguridad básicos
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Remover headers que revelan información del servidor
    Header unset X-Powered-By
    Header unset Server
    
    # Headers específicos para modo debug
    <Files "index.php">
        Header set X-App-Debug "enabled"
    </Files>
</IfModule>

# ===== PROTECCIÓN DE ARCHIVOS SENSIBLES =====
# Bloquear archivos sensibles (compatible con Apache 2.2/2.4)
<FilesMatch "\.(env|ini|phps|log|sh|bak|config|sql|tpl\.php)$">
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
</FilesMatch>

# ===== PROTECCIÓN ADICIONAL PARA DEBUG =====
# Bloquear archivos de debug si se acceden directamente (solo permitir desde panel)
<FilesMatch "\.(debug|debug_|htaccess_debug|htaccess_logs)$">
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
    <IfModule mod_authz_core.c>
        # Permitir solo si viene referer del panel de debug
        RewriteEngine On
        RewriteCond %{HTTP_REFERER} /setap/debug/
        RewriteRule . - [L]
        Require all denied
    </IfModule>
</FilesMatch>

# ===== CONFIGURACIÓN PARA MANEJAR ERRORES EN DEBUG =====
<IfModule mod_rewrite.c>
    # Permitir acceso a archivos de manejo de errores
    RewriteRule ^(detailed_errors|error_analyzer)\.php$ - [L]
</IfModule>

<Files "detailed_errors.php">
    <RequireAll>
        Require all granted
    </RequireAll>
</Files>

<Files "error_analyzer.php">
    <RequireAll>
        Require all granted
    </RequireAll>
</Files>

# ===== CHARSET Y CODIFICACIÓN =====
AddDefaultCharset UTF-8

# ===== CACHE OPTIMIZADO PARA DEBUG =====
# Cache más agresivo para assets estáticos
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Archivos estáticos con cache más largo
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType image/vnd.microsoft.icon "access plus 1 year"
    
    # CSS y JS con cache más largo para desarrollo
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    
    # Fuentes con cache
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType application/font-woff "access plus 1 month"
    
    # Archivos con cache más corto para debug
    ExpiresByType text/html "access plus 1 hour"
    ExpiresDefault "access plus 1 month"
</IfModule>

# ===== COMPRESIÓN PARA MEJOR RENDIMIENTO =====
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/ld+json
</IfModule>

# ===== PROTECCIÓN CONTRA ATAQUES =====
<IfModule mod_rewrite.c>
    # Prevenir ataques de inclusión de archivos
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=https:// [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=(\.\./?)* [OR]
    RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=/([a-z0-9_.] /?)+ [NC]
    RewriteRule .* - [F]
    
    # Bloquear intentos de SQL injection
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (SELECT|INSERT|UPDATE|DELETE|DROP|CREATE) [NC,OR]
    RewriteCond %{QUERY_STRING} (UNION|SELECT|INSERT|UPDATE|DELETE|DROP|CREATE) [NC,OR]
    RewriteCond %{QUERY_STRING} concat [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Bloquear archivos maliciosos comunes
    RewriteRule ^(.*)/phpinfo\.php$ - [F,L]
    RewriteRule ^(.*)/eval\(.*$ - [F,L]
    RewriteRule ^(.*)/base64_decode\(.*$ - [F,L]
</IfModule>

# ===== CONFIGURACIÓN ESPECÍFICA PARA MANEJO DE ERRORES =====
<IfModule mod_php.c>
    # Habilitar mostrar errores solo en modo debug
    php_flag display_errors On
    php_flag display_startup_errors On
    php_value error_reporting E_ALL
    php_value log_errors On
    php_value error_log "/setap/logs/php_errors.log"
</IfModule>

# ===== PROTECCIÓN PARA ARCHIVOS DE CONFIGURACIÓN =====
# Añadir headers específicos para archivos de configuración
<FilesMatch "\.(env|config|ini)$">
    <IfModule mod_headers.c>
        Header set Content-Disposition "attachment"
        Header set X-Content-Type-Options nosniff
    </IfModule>
</FilesMatch>

# PHP Handler - Activar según entorno
<IfModule mime_module>
  ## PHP Handler (production - cPanel EasyApache)
  #AddHandler application/x-httpd-ea-php83 .php .php8 .phtml
  
  # PHP Handler (local - Apache estándar Windows)
  AddHandler application/x-httpd-php .php .php8 .phtml
</IfModule>

# ===== CONFIGURACIÓN FINAL PARA DEBUG =====
# Headers finales que indican modo debug activo
<IfModule mod_headers.c>
    Header set X-Debug-Public "enabled"
    Header set X-Error-Handling "verbose"
    Header set X-Cache-Policy "debug-friendly"
</IfModule>

# ===== NOTA PARA PRODUCCIÓN =====
# Después de terminar debugging, eliminar:
# 1. Headers específicos de debug (X-App-Debug, X-Debug-*, etc.)
# 2. Los "Require all granted" para detailed_errors.php y error_analyzer.php
# 3. Las reglas especiales para archivos de debug
# 4. Los headers de PHP que muestran errores
# 5. Renombrar este archivo a .htaccess.production si quieres conservar backup
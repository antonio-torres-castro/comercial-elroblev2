# .htaccess mejorado para directorio /setap/
# Permite acceso a herramientas de debug mientras mantiene seguridad

# Permitir acceso a carpeta de debug desde IPs autorizadas
<Directory "debug">
    # Permitir solo archivos PHP específicos de debug
    <FilesMatch "^(web_debug_panel|web_debug_actions|log_viewer|db_analyzer)\.php$">
        <RequireAll>
            # Permitir desde localhost y IP específica
            Require ip 127.0.0.1
            Require ip ::1
            # REEMPLAZA con tu IP pública real
            Require ip TU_IP_PUBLICA_AQUI
        </RequireAll>
    </FilesMatch>
    
    # Denegar acceso a cualquier otro archivo
    <FilesMatch ".*">
        <RequireAll>
            Require all denied
        </RequireAll>
    </FilesMatch>
</Directory>

# Redirigir todo el tráfico a la carpeta public/ (configuración existente)
<IfModule mod_rewrite.c>
    RewriteEngine On
    # RewriteBase /setap/
    
    # Redirigir todo a la carpeta public/ EXCEPTO la carpeta debug
    RewriteCond %{REQUEST_URI} !^/setap/public/
    RewriteCond %{REQUEST_URI} !^/setap/debug/
    RewriteRule ^(.*)$ public/$1 [L]
</IfModule>

# Evitar listado de directorios
Options -Indexes

# Bloquear acceso a archivos sensibles
<FilesMatch "\.(env|ini|log|sh|bak|config|sql)$">
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
</FilesMatch>

# Bloquear archivos específicos de debugging en producción
<FilesMatch "^(production_debug_tool|simple_debug_panel)\.php$">
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
</FilesMatch>

# PHP Handler - Activar según entorno
<IfModule mime_module>
  ## PHP Handler (production - cPanel EasyApache)
  #AddHandler application/x-httpd-ea-php83 .php .php8 .phtml
  
  # PHP Handler (local - Apache estándar Windows)
  AddHandler application/x-httpd-php .php .php8 .phtml
</IfModule>

# Headers de seguridad adicionales
<IfModule mod_headers.c>
    # Prevenir clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    # Prevenir MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    # Activar protección XSS
    Header always set X-XSS-Protection "1; mode=block"
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Compresión para mejorar rendimiento
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Cache para archivos estáticos (excluir debug)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>